name: Android CI

on:
  push:
    branches: [ main ]

jobs:
  build:
    name: Build & Notify
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace

#      - name: Build Release APK
#        run: ./gradlew assembleRelease --stacktrace

      - name: Telegram Success
        if: ${{ success() }}
        run: |
          messages=(
            "–í–µ—á–µ—Ä–æ–∫ –≤ —Ö–∞—Ç—É, —Ç—É—Ç –æ–±–Ω–æ–≤–∞ –ø–æ–¥—ä–µ—Ö–∞–ª–∞"
            "–°–±–æ—Ä–∫–∞ –≤–∑–ª–µ—Ç–µ–ª–∞, –∫–∞–∫ —Ä–∞–∫–µ—Ç–∞ –≤ –∫–æ—Å–º–æ—Å"
            "CI –º–∏–Ω–æ–≤–∞–ª –±—É—Ä—é –∏ –¥–æ—Å—Ç–∞–≤–∏–ª APK —Ü–µ–ª—ã–º"
            "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ä–∞–π–æ–Ω–µ ‚Äî –∫–∞—á–∞–µ–º, –Ω–µ —Ç–æ—Ä–º–æ–∑–∏–º"
            "–†–µ–ª–∏–∑ –≥–æ—Ç–æ–≤, –±–∞–≥–∏ —Å–¥–∞—ë–º –±–µ–∑ –ø–æ—Ç–µ—Ä—å"
            "–ê–ø–¥–µ–π—Ç –ø—Ä–æ—à—ë–ª, –∫–∞–∫ –ø–æ –º–∞—Å–ª—É"
            "–ö–æ–¥ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚Äî –ø—Ä–∞–∑–¥–Ω–∏–∫ —É–¥–∞–ª—Å—è"
            "Debug-–≤–µ—Ä—Å–∏—è —á—ë—Ç–∫–∞—è, –∫–∞–∫ —É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ—Ñ–µ"
            "–°–±–æ—Ä–∫–∞ –∏–¥–µ–∞–ª—å–Ω–∞—è, –¥–∞–∂–µ –ª–∏–Ω—Ç–µ—Ä –≤ —à–æ–∫–µ"
            "APK –≤—ã–µ—Ö–∞–ª –Ω–∞ —Ç—Ä–∞—Å—Å—É, –µ–¥–µ–º –±–µ–∑ –ø—Ä–æ–±–æ–∫"
            "CI-–¥–∂–∏–≥–∏—Ç —É–∫—Ä–æ—Ç–∏–ª —Ç–µ—Å—Ç—ã –∏ —Å–æ–±—Ä–∞–ª –±–∏–ª–¥"
            "–ù–æ–≤—ã–π –±–∏–ª–¥ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ ‚Äî —Ä–∞–∑–≥–æ–Ω—è–µ–º—Å—è!"
            "–ë–∞–≥–∏ —Å—Ö–ª–æ–ø–Ω—É–ª–∏—Å—å, —Ä–µ–ª–∏–∑ —Å–∏—è–µ—Ç"
            "–ü—É—à –≤ main ‚Äî –≤—Ä—ã–≤–∞–µ–º—Å—è —Å –∞–ø–¥–µ–π—Ç–æ–º"
            "–°–µ—Ä–≤–µ—Ä –æ–¥–æ–±—Ä–∏–ª, –º—ã –≤—ã–∫–∞—Ç—ã–≤–∞–µ–º –Ω–æ–≤–∏–Ω–∫—É"
            "APK –≤ —Ç–µ–ª–µ–≥—É —É—à—ë–ª ‚Äî –ø–æ–∑–¥—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É"
            "–°–±–æ—Ä–∫–∞ –ø—Ä–æ–∫–∞—á–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø—ã—Ç–∞–Ω–∏—è–º"
            "–í—Å–µ —Ç–µ—Å—Ç—ã –≤ —à–æ–∫–µ –æ—Ç —Å–∫–æ—Ä–æ—Å—Ç–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è"
            "–ü—Ä–æ–µ–∫—Ç –æ–±–Ω–æ–≤–ª—ë–Ω ‚Äî –º–∏—Ä —Å–ø–∞—Å—ë–Ω"
            "–ù–∞—à–∞ —Å–±–æ—Ä–∫–∞ ‚Äî –∫–∞–∫ –Ω–æ–≤–æ–≥–æ–¥–Ω—è—è —ë–ª–∫–∞: —Å–∏—è–µ—Ç"
            "–í–µ—Ä—Å–∏—è –≥–æ—Ä—è—á–∞—è, –∫–∞–∫ –ø–µ–ª—å–º–µ–Ω–∏"
          )
          idx=$(( RANDOM % ${#messages[@]} ))
          random_msg="${messages[$idx]}"

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            COMMENT="${{ github.event.pull_request.title }}"
          else
            COMMENT="${{ github.event.head_commit.message }}"
          fi

          caption="‚úÖ $random_msg\n\n–í–æ—Ç –Ω–æ–≤–∞—è –¥–µ–±–∞–≥-–≤–µ—Ä—Å–∏—è.\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: *$COMMENT*"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument" \
            -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -F document=@"${GITHUB_WORKSPACE}/app/build/outputs/apk/debug/app-debug.apk" \
            -F caption="$caption" \
            -F parse_mode=Markdown

      #          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument" \
#            -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
#            -F document=@"${GITHUB_WORKSPACE}/app/build/outputs/apk/release/app-release-unsigned.apk" \
#            -F caption="–í—Å–µ –ø—Ä–æ—à–ª–æ —Å—É–ø–µ—Ä, –≤–æ—Ç —Ä–µ–ª–∏–∑ –≤–µ—Ä—Å–∏—è ü§Øü§Øü§Ø"

      - name: Telegram Failure
        if: ${{ failure() }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="–£–ø—Å, —á—Ç–æ-—Ç–æ –ø–æ–ª–æ–º–∞–ª–æ—Å—å, —Ç–∞–∫ —á—Ç–æ –ø–æ–∫–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –Ω–µ –±—É–¥–µ—Ç ü§¨ü§¨ü§¨"
